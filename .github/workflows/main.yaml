name: Linux-TKG Silvermont Extreme Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  _processor_opt: "silvermont"
  _cpusched: "pds"
  _compiler: "gcc"
  _distro: "Arch"
  _kernel_on_diet: "false" 
  _modprobeddb: "true"
  _modprobeddb_db_path: "/home/user/modprobed.db"
  _debugdisable: "true"
  _no_confirm: "true"
  PKGDEST: "/home/user/reales_paquetes"
  SRCDEST: "/home/user/sources"

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    container: 
      image: archlinux:latest
      options: --user root

    steps:
      - name: 1. Sincronizar Sistema y Toolchain (Fix Assembler)
        run: |
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Sy --noconfirm archlinux-keyring
          pacman -Syu --noconfirm
          pacman -S --needed --noconfirm git base-devel sudo bc ccache kmod cpio perl tar xz wget \
          pahole python-sphinx python-sphinx_rtd_theme patchutils xmlto docbook-xsl \
          inetutils flex graphviz imagemagick bison libelf llvm clang

      - name: 2. Checkout
        uses: actions/checkout@v4

      - name: 3. Configurar Usuario y Carpetas
        run: |
          useradd -m user
          echo "user ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          mkdir -p ${{ env.SRCDEST }}
          mkdir -p ${{ env.PKGDEST }}
          chown -R user:user /home/user

      - name: 4. Cachear fuentes del Kernel
        uses: actions/cache@v4
        with:
          path: /home/user/sources
          key: kernel-sources-${{ hashFiles('**/PKGBUILD') }}
          restore-keys: |
            kernel-sources-

      - name: 5. Preparar Repositorio TKG
        run: |
          git clone --depth 1 https://github.com/Frogging-Family/linux-tkg.git /home/user/linux-tkg
          cp customization.cfg /home/user/linux-tkg/
          cp modprobed.db /home/user/modprobed.db
          chown -R user:user /home/user/linux-tkg
          chown user:user /home/user/modprobed.db

      - name: 6. Parche Maestro Fix BTF y Advertencias
        run: |
          # Desactivamos BTF (que causa el error de libbpf.c) y drivers pesados
          # Inyectamos flags para que GCC no se detenga por advertencias (-Wno-error)
          sed -i '/_tkg_srcprep/a \  scripts/config --file "${_kernel_work_folder_abs}/.config" --disable CONFIG_DEBUG_INFO_BTF' /home/user/linux-tkg/PKGBUILD
          sed -i '/_tkg_srcprep/a \  scripts/config --file "${_kernel_work_folder_abs}/.config" --disable CONFIG_DRM_AMDGPU --disable CONFIG_DRM_NOUVEAU --disable CONFIG_DRM_RADEON' /home/user/linux-tkg/PKGBUILD

      - name: 7. Compilación (Con Flags de Emergencia)
        working-directory: /home/user/linux-tkg
        run: |
          # KCFLAGS="-Wno-error" permite que el kernel ignore los fallos de código en libbpf
          # PATH forzado para que encuentre el assembler (as)
          su -m user -c "export SRCDEST=${{ env.SRCDEST }}; \
                      export KCFLAGS='-Wno-error'; \
                      export MAKEFLAGS='-j$(nproc) WERROR=0'; \
                      export PATH='/usr/bin:/usr/lib/ccache/bin:$PATH'; \
                      export _processor_opt=silvermont; \
                      export _cpusched=pds; \
                      export _distro=Arch; \
                      export _kernel_on_diet=false; \
                      export _modprobeddb=true; \
                      export _modprobeddb_db_path=/home/user/modprobed.db; \
                      export _debugdisable=true; \
                      export _no_confirm=true; \
                      export PKGDEST=${{ env.PKGDEST }}; \
                      yes '' | makepkg --noconfirm -s"

      - name: 8. Subir Paquetes Finales
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: kernel-silvermont-v19
          path: /home/user/reales_paquetes/*.pkg.tar.zst
