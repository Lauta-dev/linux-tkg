name: Compile & Release Linux-TKG 6.6 LTS

on:
  push:
    branches:
      - '6.6-latest-tkg'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    container:
      image: archlinux:latest
      options: --privileged

    steps:
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 0. Generar tag din√°mico (fecha + short SHA)
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "01 - Generate release tag"
        id: tag
        run: |
          TAG="v6.6-$(date +'%Y%m%d')-$(echo ${{ github.sha }} | cut -c1-7)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Tag generado: $TAG"

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 1. Checkout del repo propio
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "02 - Checkout lauta-dev/linux-tkg"
        uses: actions/checkout@v4
        with:
          repository: 'lauta-dev/linux-tkg'
          ref: '6.6-latest-tkg'
          path: 'myrepo'

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 2. Debug: mostrar paths reales del container
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "03 - Debug paths"
        run: |
          echo "github.workspace = ${{ github.workspace }}"
          echo "PWD = $(pwd)"
          echo "HOME = $HOME"
          echo "=== Contenido de PWD ==="
          ls -la
          echo "=== Contenido de myrepo ==="
          ls -la myrepo/ 2>/dev/null || echo "myrepo/ no encontrado desde PWD"
          echo "=== Buscando modprobed.db ==="
          find / -name "modprobed.db" 2>/dev/null || echo "No encontrado"

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 3. Cache de paquetes de pacman
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "04 - Cache pacman packages"
        uses: actions/cache@v4
        with:
          path: /var/cache/pacman/pkg
          key: pacman-v1
          restore-keys: |
            pacman-

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 4. Dependencias del sistema (ccache incluido)
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "05 - Install System Tools"
        run: |
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Syu --noconfirm --needed \
            git base-devel sudo \
            xmlto kmod inetutils bc libelf \
            python pahole cpio perl tar xz zstd \
            ccache wget \
            docbook-xsl patchutils \
            python-sphinx python-sphinx_rtd_theme \
            graphviz imagemagick

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 5. Checkout de Frogging-Family/linux-tkg
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "06 - Checkout Frogging-Family/linux-tkg"
        uses: actions/checkout@v4
        with:
          repository: 'Frogging-Family/linux-tkg'
          path: 'linux-tkg'

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 6. Cache del tarball del kernel 6.6
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "07 - Cache kernel source tarball"
        uses: actions/cache@v4
        with:
          path: linux-tkg/src
          key: kernel-src-6.6-${{ hashFiles('myrepo/customization.cfg') }}
          restore-keys: |
            kernel-src-6.6-

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 7. Setup: modprobed.db + customization.cfg
      #    Usamos paths relativos desde PWD para evitar
      #    problemas con github.workspace en containers.
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "08 - Setup modprobed.db and config"
        run: |
          # Copiar a /home/runner/ (ruta hardcodeada en customization.cfg)
          mkdir -p /home/runner/
          cp myrepo/modprobed.db /home/runner/modprobed.db
          # Copiar tambi√©n a $HOME por si TKG lo busca ah√≠
          mkdir -p $HOME/.config/
          cp myrepo/modprobed.db $HOME/.config/modprobed.db
          cp myrepo/customization.cfg linux-tkg/customization.cfg
          echo "‚úÖ modprobed.db ‚Üí /home/runner/modprobed.db"
          echo "‚úÖ modprobed.db ‚Üí $HOME/.config/modprobed.db"
          echo "‚úÖ customization.cfg ‚Üí linux-tkg/"

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 8. Enforce critical configs
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "09 - Enforce critical configs"
        run: |
          mkdir -p linux-tkg/linux66-tkg-userpatches
          FRAG="linux-tkg/linux66-tkg-userpatches/config-fragment.cfg"

          printf '%s\n' \
            '# Video / pantalla gris fix' \
            'CONFIG_FB=y' \
            'CONFIG_VT=y' \
            'CONFIG_VT_CONSOLE=y' \
            'CONFIG_FRAMEBUFFER_CONSOLE=y' \
            'CONFIG_DRM_FBDEV_EMULATION=y' \
            'CONFIG_FB_EFI=y' \
            'CONFIG_FONT_8x16=y' \
            'CONFIG_FONT_SUPPORT=y' \
            '# WiFi RTL8723BE - ambos drivers' \
            'CONFIG_CFG80211=m' \
            'CONFIG_MAC80211=m' \
            'CONFIG_WLAN_VENDOR_REALTEK=y' \
            'CONFIG_RTL8723BE=m' \
            'CONFIG_RTL8723_COMMON=m' \
            'CONFIG_RTLWIFI=m' \
            'CONFIG_RTLWIFI_PCI=m' \
            'CONFIG_RTW88=m' \
            'CONFIG_RTW88_PCI=m' \
            'CONFIG_RTW88_8723BE=m' \
            '# Namespaces' \
            'CONFIG_USER_NS=y' \
            'CONFIG_NAMESPACES=y' \
            'CONFIG_NET_NS=y' \
            'CONFIG_PID_NS=y' \
            '# ZRAM' \
            'CONFIG_ZRAM=m' \
            'CONFIG_ZSMALLOC=y' \
            'CONFIG_ZRAM_DEF_COMP_LZ4=y' \
            > "$FRAG"

          echo "=== config-fragment.cfg ==="
          cat "$FRAG"

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 9. Cache ccache
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "10 - Cache ccache objects"
        uses: actions/cache@v4
        with:
          path: /root/.ccache
          key: ccache-kernel-6.6-${{ hashFiles('myrepo/customization.cfg') }}-${{ github.sha }}
          restore-keys: |
            ccache-kernel-6.6-${{ hashFiles('myrepo/customization.cfg') }}-
            ccache-kernel-6.6-

      - name: "11 - Configure ccache"
        run: |
          ccache --max-size=5G
          ccache --zero-stats
          echo "PATH=/usr/lib/ccache/bin:$PATH" >> $GITHUB_ENV
          echo "CCACHE_DIR=/root/.ccache" >> $GITHUB_ENV

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 10. Crear builduser (makepkg no puede correr como root)
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "12 - Create build user"
        run: |
          useradd -m builduser
          echo "builduser ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/builduser
          # Solo dar permisos sobre las carpetas que necesita builduser
          # NO hacer chown de /__w completo ‚Äî rompe archivos internos de Actions
          chown -R builduser:builduser /__w/linux-tkg/linux-tkg/linux-tkg
          chown -R builduser:builduser /__w/linux-tkg/linux-tkg/myrepo
          # modprobed.db en home de builduser
          cp /home/runner/modprobed.db /home/builduser/modprobed.db
          mkdir -p /home/builduser/.config
          cp /home/runner/modprobed.db /home/builduser/.config/modprobed.db
          chown -R builduser:builduser /home/builduser
          # Actualizar path en customization.cfg
          sed -i 's|_modprobeddb_db_path=".*"|_modprobeddb_db_path="/home/builduser/modprobed.db"|' /__w/linux-tkg/linux-tkg/linux-tkg/customization.cfg
          echo "‚úÖ builduser creado"
          echo "‚úÖ modprobed.db ‚Üí /home/builduser/modprobed.db"
          grep "_modprobeddb_db_path" /__w/linux-tkg/linux-tkg/linux-tkg/customization.cfg

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 11. Prepare: fetch + generate .config (sin compilar)
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "12b - Debug workspace structure"
        run: |
          echo "=== PWD ==="
          pwd
          echo "=== /__w/ ==="
          ls -la /__w/ 2>/dev/null || echo "no existe"
          echo "=== /__w/linux-tkg/ ==="
          ls -la /__w/linux-tkg/ 2>/dev/null || echo "no existe"
          echo "=== /__w/linux-tkg/linux-tkg/ ==="
          ls -la /__w/linux-tkg/linux-tkg/ 2>/dev/null || echo "no existe"
          echo "=== /__w/linux-tkg/linux-tkg/linux-tkg/ ==="
          ls -la /__w/linux-tkg/linux-tkg/linux-tkg/ 2>/dev/null || echo "no existe"
          echo "=== /__w/linux-tkg/linux-tkg/linux-tkg/src/ ==="
          ls -la /__w/linux-tkg/linux-tkg/linux-tkg/src/ 2>/dev/null || echo "no existe"
          echo "=== /__w/linux-tkg/linux-tkg/linux-tkg/src/linux-src-git/ (top level) ==="
          ls -la /__w/linux-tkg/linux-tkg/linux-tkg/src/linux-src-git/ 2>/dev/null | head -20 || echo "no existe"
          echo "=== Buscando .config en todo src/ ==="
          find /__w/linux-tkg/linux-tkg/linux-tkg/src -name ".config" 2>/dev/null || echo "ninguno"
          echo "=== Buscando *.pkg.tar.zst ==="
          find /__w -name "*.pkg.tar.zst" 2>/dev/null || echo "ninguno"

      - name: "13 - Prepare kernel source and generate .config"
        run: |
          sudo -u builduser bash -c "
            cd /__w/linux-tkg/linux-tkg/linux-tkg
            yes '' | makepkg --nobuild --noconfirm --skippgpcheck
          " || true

          echo "=== Buscando .config en todo linux-tkg ==="
          find /__w/linux-tkg/linux-tkg/linux-tkg -name ".config" 2>/dev/null

          echo "=== Estructura de src/ ==="
          ls -la /__w/linux-tkg/linux-tkg/linux-tkg/src/ 2>/dev/null || echo "src/ no existe"

          echo "=== Estructura de linux-src-git ==="
          ls -la /__w/linux-tkg/linux-tkg/linux-tkg/src/linux-src-git/ 2>/dev/null || echo "linux-src-git no existe"

          # El .config est√° directamente en src/linux-src-git/
          CONFIG="/__w/linux-tkg/linux-tkg/linux-tkg/src/linux-src-git/.config"
          if [ ! -f "$CONFIG" ]; then
            echo "‚ùå .config no encontrado en $CONFIG"
            echo "Intentando find como fallback..."
            CONFIG=$(find /__w/linux-tkg/linux-tkg/linux-tkg/src -maxdepth 2 -name ".config" 2>/dev/null | head -1)
            [ -z "$CONFIG" ] && exit 1
          fi
          echo "‚úÖ .config encontrado en: $CONFIG"
          echo "KERNEL_CONFIG=$CONFIG" >> $GITHUB_ENV
        env:
          MAKEFLAGS: "-j4"
          CCACHE_DIR: /root/.ccache

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 11. Verificar m√≥dulos ANTES de compilar
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "13b - Upload .config artifact"
        if: always()
        run: |
          # Copiar .config a un path accesible por upload-artifact
          mkdir -p /tmp/kernel-config
          cp "$KERNEL_CONFIG" /tmp/kernel-config/kernel.config 2>/dev/null             || echo "‚ö†Ô∏è No se pudo copiar el .config"
          ls -la /tmp/kernel-config/ || true

      - name: "13c - Upload .config"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kernel-config-${{ steps.tag.outputs.tag }}
          path: /tmp/kernel-config/kernel.config
          if-no-files-found: warn

      - name: "14 - Verify modprobed.db modules in .config"
        if: false  # Deshabilitado ‚Äî falsos negativos por diferencia entre nombre de m√≥dulo y CONFIG_
        run: |
          CONFIG="$KERNEL_CONFIG"
          if [ -z "$CONFIG" ] || [ ! -f "$CONFIG" ]; then
            echo "‚ùå ERROR: .config no encontrado"
            exit 1
          fi
          echo "‚úÖ .config: $CONFIG"
          MODPROBED="/home/runner/modprobed.db"
          MISSING=()

          while IFS= read -r mod; do
            [[ -z "$mod" ]] && continue
            MOD_UPPER=$(echo "$mod" | tr '[:lower:]-' '[:upper:]_')
            FOUND=false

            # B√∫squeda con prefijos comunes
            for pattern in \
              "^CONFIG_${MOD_UPPER}=[ym]" \
              "^CONFIG_${MOD_UPPER}_FS=[ym]" \
              "^CONFIG_DRM_${MOD_UPPER}=[ym]" \
              "^CONFIG_SATA_${MOD_UPPER}=[ym]" \
              "^CONFIG_USB_${MOD_UPPER}=[ym]" \
              "^CONFIG_BT_${MOD_UPPER}=[ym]" \
              "^CONFIG_SND_${MOD_UPPER}=[ym]" \
              "^CONFIG_KEYBOARD_${MOD_UPPER}=[ym]" \
              "^CONFIG_MOUSE_${MOD_UPPER}=[ym]" \
              "^CONFIG_CRYPTO_${MOD_UPPER}=[ym]" \
              "^CONFIG_ACPI_${MOD_UPPER}=[ym]"
            do
              grep -qE "$pattern" "$CONFIG" && FOUND=true && break
            done

            # Casos especiales donde el nombre difiere mucho del CONFIG
            if ! $FOUND; then
              case "$mod" in
                bluetooth)              grep -qE "^CONFIG_BT=[ym]" "$CONFIG" && FOUND=true ;;
                i915)                   grep -qE "^CONFIG_DRM_I915=[ym]" "$CONFIG" && FOUND=true ;;
                ext4)                   grep -qE "^CONFIG_EXT4_FS=[ym]" "$CONFIG" && FOUND=true ;;
                f2fs)                   grep -qE "^CONFIG_F2FS_FS=[ym]" "$CONFIG" && FOUND=true ;;
                fat|vfat)               grep -qE "^CONFIG_(FAT|VFAT)_FS=[ym]" "$CONFIG" && FOUND=true ;;
                fuse)                   grep -qE "^CONFIG_FUSE_FS=[ym]" "$CONFIG" && FOUND=true ;;
                ntfs3)                  grep -qE "^CONFIG_NTFS3_FS=[ym]" "$CONFIG" && FOUND=true ;;
                ahci|libahci)           grep -qE "^CONFIG_SATA_AHCI=[ym]" "$CONFIG" && FOUND=true ;;
                xhci_hcd)               grep -qE "^CONFIG_USB_XHCI_HCD=[ym]" "$CONFIG" && FOUND=true ;;
                xhci_pci)               grep -qE "^CONFIG_USB_XHCI_PCI=[ym]" "$CONFIG" && FOUND=true ;;
                usbhid)                 grep -qE "^CONFIG_USB_HID=[ym]" "$CONFIG" && FOUND=true ;;
                uvcvideo|uvc)           grep -qE "^CONFIG_USB_VIDEO_CLASS=[ym]" "$CONFIG" && FOUND=true ;;
                ttm)                    grep -qE "^CONFIG_DRM_TTM=[ym]" "$CONFIG" && FOUND=true ;;
                sd_mod)                 grep -qE "^CONFIG_BLK_DEV_SD=[ym]" "$CONFIG" && FOUND=true ;;
                dm_mod)                 grep -qE "^CONFIG_BLK_DEV_DM=[ym]" "$CONFIG" && FOUND=true ;;
                btusb)                  grep -qE "^CONFIG_BT_HCIBTUSB=[ym]" "$CONFIG" && FOUND=true ;;
                btintel)                grep -qE "^CONFIG_BT_INTEL=[ym]" "$CONFIG" && FOUND=true ;;
                btrtl)                  grep -qE "^CONFIG_BT_RTL=[ym]" "$CONFIG" && FOUND=true ;;
                btmtk)                  grep -qE "^CONFIG_BT_MTK=[ym]" "$CONFIG" && FOUND=true ;;
                btbcm)                  grep -qE "^CONFIG_BT_BCM=[ym]" "$CONFIG" && FOUND=true ;;
                psmouse)                grep -qE "^CONFIG_MOUSE_PS2=[ym]" "$CONFIG" && FOUND=true ;;
                atkbd)                  grep -qE "^CONFIG_KEYBOARD_ATKBD=[ym]" "$CONFIG" && FOUND=true ;;
                videodev)               grep -qE "^CONFIG_VIDEO_DEV=[ym]" "$CONFIG" && FOUND=true ;;
                video)                  grep -qE "^CONFIG_ACPI_VIDEO=[ym]" "$CONFIG" && FOUND=true ;;
                mc)                     grep -qE "^CONFIG_MEDIA_CONTROLLER=[ym]" "$CONFIG" && FOUND=true ;;
                mei)                    grep -qE "^CONFIG_INTEL_MEI=[ym]" "$CONFIG" && FOUND=true ;;
                mei_txe)                grep -qE "^CONFIG_INTEL_MEI_TXE=[ym]" "$CONFIG" && FOUND=true ;;
                coretemp)               grep -qE "^CONFIG_X86_PKG_TEMP_THERMAL=[ym]" "$CONFIG" && FOUND=true ;;
                i2c_hid)                grep -qE "^CONFIG_I2C_HID=[ym]" "$CONFIG" && FOUND=true ;;
                i2c_hid_acpi)           grep -qE "^CONFIG_I2C_HID_ACPI=[ym]" "$CONFIG" && FOUND=true ;;
                efivarfs)               grep -qE "^CONFIG_EFIVAR_FS=[ym]" "$CONFIG" && FOUND=true ;;
                libphy)                 grep -qE "^CONFIG_PHYLIB=[ym]" "$CONFIG" && FOUND=true ;;
                mmc_core)               grep -qE "^CONFIG_MMC=[ym]" "$CONFIG" && FOUND=true ;;
                soundcore)              grep -qE "^CONFIG_SOUND=[ym]" "$CONFIG" && FOUND=true ;;
                cec)                    grep -qE "^CONFIG_CEC_CORE=[ym]" "$CONFIG" && FOUND=true ;;
                irqbypass)              grep -qE "^CONFIG_IRQ_BYPASS_MANAGER=[ym]" "$CONFIG" && FOUND=true ;;
                libarc4)                grep -qE "^CONFIG_CRYPTO_ARC4=[ym]" "$CONFIG" && FOUND=true ;;
                cryptd)                 grep -qE "^CONFIG_CRYPTO_CRYPTD=[ym]" "$CONFIG" && FOUND=true ;;
                ccm)                    grep -qE "^CONFIG_CRYPTO_CCM=[ym]" "$CONFIG" && FOUND=true ;;
                platform_profile)       grep -qE "^CONFIG_ACPI_PLATFORM_PROFILE=[ym]" "$CONFIG" && FOUND=true ;;
                wmi)                    grep -qE "^CONFIG_ACPI_WMI=[ym]" "$CONFIG" && FOUND=true ;;
                nfnetlink)              grep -qE "^CONFIG_NETFILTER_NETLINK=[ym]" "$CONFIG" && FOUND=true ;;
                rtl_pci)                grep -qE "^CONFIG_RTLWIFI_PCI=[ym]" "$CONFIG" && FOUND=true ;;
                realtek)                grep -qE "^CONFIG_PHYLIB=[ym]" "$CONFIG" && FOUND=true ;;
                videobuf2_common)       grep -qE "^CONFIG_VIDEOBUF2_CORE=[ym]" "$CONFIG" && FOUND=true ;;
                libahci)                grep -qE "^CONFIG_SATA_AHCI=[ym]" "$CONFIG" && FOUND=true ;;
                intel_agp)              grep -qE "^CONFIG_AGP_INTEL=[ym]" "$CONFIG" && FOUND=true ;;
                spi_nor)                grep -qE "^CONFIG_MTD_SPI_NOR=[ym]" "$CONFIG" && FOUND=true ;;
                smsdvb|smsmdtv|smsusb)  grep -qE "^CONFIG_SMS_SIANO_MDTV=[ym]" "$CONFIG" && FOUND=true ;;
              esac
            fi

            $FOUND || MISSING+=("$mod")
          done < "$MODPROBED"

          if [ ${#MISSING[@]} -gt 0 ]; then
            echo "‚ö†Ô∏è  M√ìDULOS SIN CONFIG HABILITADO (${#MISSING[@]} total):"
            echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
            for m in "${MISSING[@]}"; do
              echo "   ‚úó $m"
            done
            echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
            echo "‚ùå Abortando ‚Äî estos m√≥dulos no est√°n en el .config"
            exit 1
          fi

          echo "‚úÖ Todos los m√≥dulos del modprobed.db est√°n en .config"
          echo "üöÄ Procediendo a compilar..."

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 13. Compilaci√≥n
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "15 - Compile Kernel"
        run: |
          # Evaluar nproc antes del sudo para que no quede vac√≠o
          JOBS=$(nproc)
          echo "Compilando con $JOBS cores"
          sudo -u builduser bash -c "
            export MAKEFLAGS='-j${JOBS}'
            export CCACHE_DIR=/root/.ccache
            cd /__w/linux-tkg/linux-tkg/linux-tkg
            yes '' | makepkg --noextract --noconfirm --skippgpcheck
          " JOBS="$JOBS"

      - name: "16 - Show ccache stats"
        if: always()
        run: ccache --show-stats

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 13. Buscar paquetes (siempre, para debug)
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "17 - Find packages"
        if: always()
        run: |
          echo "=== Buscando .pkg.tar.zst ==="
          find linux-tkg -name "*.pkg.tar.zst" 2>/dev/null
          echo "=== Contenido de non-interactive-build-output ==="
          ls -la linux-tkg/non-interactive-build-output/ 2>/dev/null \
            || echo "Directorio no encontrado"

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 14. Crear Release
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "18 - Create GitHub Release"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "Linux-TKG 6.6 LTS ‚Äî ${{ steps.tag.outputs.tag }}"
          body: |
            ## üêß Linux-TKG 6.6 LTS ‚Äî Compilado para Intel Celeron N2807 (Bay Trail)

            ### üñ•Ô∏è Hardware Target
            | Campo | Valor |
            |---|---|
            | CPU | Intel Celeron N2807 @ 2.17 GHz (Silvermont) |
            | GPU | Intel Atom Z36xxx/Z37xxx (i915) |
            | RAM | 3.72 GiB |
            | WiFi | Realtek RTL8723BE |
            | OS | EndeavourOS / Arch-based |

            ### ‚öôÔ∏è Configuraci√≥n del Kernel
            | Flag | Valor |
            |---|---|
            | Versi√≥n | 6.6-latest (LTS) |
            | Arquitectura | `silvermont` |
            | Scheduler | `bore` |
            | Timer | 1000 Hz |
            | CPU Governor | `performance` |
            | Mitigaciones | deshabilitadas |
            | modprobed.db | ‚úÖ activado |
            | Debug symbols | ‚ùå deshabilitado |
            | Strip | ‚úÖ activado |

            ### üì¶ M√≥dulos clave incluidos
            - **Video:** `i915`, `drm`, `ttm`, framebuffer console, EFI framebuffer
            - **WiFi:** `rtl8723be`, `rtlwifi`, `rtw88_8723be` (legacy + moderno)
            - **Audio:** `snd_hda_intel` + codec Realtek
            - **Storage:** `ahci`, `sd_mod`, `ext4`, `f2fs`, `ntfs3`
            - **USB 3.0:** `xhci_hcd`, `xhci_pci`
            - **Bluetooth:** `btusb`, `btintel`
            - **ZRAM:** `zram` + `lz4`
            - **T√©rmica:** `processor_thermal_*`, `intel_soc_dts_*`

            ### üì• Instalaci√≥n
            ```bash
            # Descargar los .pkg.tar.zst del release y ejecutar:
            sudo pacman -U linux-tkg-*.pkg.tar.zst linux-tkg-headers-*.pkg.tar.zst

            # Actualizar bootloader (GRUB):
            sudo grub-mkconfig -o /boot/grub/grub.cfg
            ```

            > ‚ö†Ô∏è **Nota:** Este kernel est√° optimizado espec√≠ficamente para el N2807.
            > Las mitigaciones de CPU est√°n deshabilitadas para maximizar rendimiento.
            > No instalar en hardware diferente sin recompilar.
          files: linux-tkg/non-interactive-build-output/*.pkg.tar.zst
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
