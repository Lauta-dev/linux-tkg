name: Linux-TKG Silvermont (Ubuntu Runner -> Raw Tarball)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04 # El entorno más estable para compilar
    steps:
      - name: 1. Checkout del repositorio
        uses: actions/checkout@v4

      - name: 2. Instalar Dependencias de Compilación (Ubuntu)
        run: |
          sudo apt-get update
          sudo apt-get install -y git build-essential bc bison flex libelf-dev libssl-dev \
          make ccache dwarves libncurses-dev xz-utils kmod

      - name: 3. Clonar TKG y Preparar Config
        run: |
          git clone --depth 1 https://github.com/Frogging-Family/linux-tkg.git
          cp customization.cfg linux-tkg/
          cp modprobed.db linux-tkg/
          
          # Forzamos las variables para tu Silvermont y PDS
          cd linux-tkg
          # --- 1. VIDEO: MATAR RAÍCES DE AMD Y NVIDIA ---
          scripts/config --disable CONFIG_DRM_AMDGPU
          scripts/config --disable CONFIG_DRM_RADEON
          scripts/config --disable CONFIG_DRM_NOUVEAU
          # Asegurar Intel para tu HDMI
          scripts/config --enable CONFIG_DRM_I915
          
          # --- 2. MULTIMEDIA: WEBCAM SI, TODO LO DEMÁS NO ---
          scripts/config --enable CONFIG_MEDIA_SUPPORT
          scripts/config --enable CONFIG_MEDIA_CAMERA_SUPPORT
          scripts/config --enable CONFIG_VIDEO_V4L2
          scripts/config --disable CONFIG_MEDIA_ANALOG_TV_SUPPORT
          scripts/config --disable CONFIG_MEDIA_DIGITAL_TV_SUPPORT
          scripts/config --disable CONFIG_MEDIA_RADIO_SUPPORT
          scripts/config --disable CONFIG_MEDIA_SDR_SUPPORT
          scripts/config --disable CONFIG_VIDEO_ADV_DEBUG
          
          # --- 3. RED: SOLO INTEL Y REALTEK ---
          scripts/config --disable CONFIG_WLAN_VENDOR_MEDIATEK
          scripts/config --disable CONFIG_WLAN_VENDOR_RALINK
          scripts/config --disable CONFIG_WLAN_VENDOR_BROADCOM
          scripts/config --disable CONFIG_WLAN_VENDOR_ATH
          scripts/config --disable CONFIG_NET_VENDOR_AMD
          scripts/config --disable CONFIG_NET_VENDOR_NVIDIA
          scripts/config --enable CONFIG_NET_VENDOR_INTEL
          scripts/config --enable CONFIG_NET_VENDOR_REALTEK
          
          # --- 4. AUDIO: HDMI INTEL OK, EL RESTO NO ---
          scripts/config --enable CONFIG_SND_HDA_CODEC_HDMI
          scripts/config --disable CONFIG_SND_HDA_CODEC_ATIHDMI
          scripts/config --disable CONFIG_SND_HDA_CODEC_NVHDMICK
          
          # --- 5. LIMPIEZA DE GRASA GENERAL ---
          scripts/config --disable CONFIG_HYPERV
          scripts/config --disable CONFIG_XEN
          scripts/config --disable CONFIG_VIRTUALIZATION
          scripts/config --set-val CONFIG_NR_CPUS 2
          scripts/config --enable CONFIG_MSILVERMONT
          
          # Forzar a que el config sea consistente (borra lo que quedó huérfano)
          make olddefconfig

      - name: 4. Compilar Kernel
        run: |
          cd linux-tkg
          # Usamos WERROR=0 para que no aborte por advertencias tontas de GCC
          export KCFLAGS="-Wno-error"
          # ./install.sh en modo Generic compila y deja los archivos en una carpeta temporal
          yes "" | ./install.sh install

      - name: 5. Empaquetar Kernel + Módulos en .tar.gz
        run: |
          # Creamos una carpeta de estructura limpia
          mkdir -p output/boot
          
          # 1. Copiamos el kernel comprimido y el mapa de símbolos
          cp linux-tkg/linux-src-git/arch/x86/boot/bzImage output/boot/vmlinuz-tkg-silvermont
          cp linux-tkg/linux-src-git/System.map output/boot/
          cp linux-tkg/linux-src-git/.config output/boot/config-tkg-silvermont
          
          # 2. Instalamos los módulos en nuestra carpeta temporal
          cd linux-tkg/linux-src-git
          sudo make INSTALL_MOD_PATH=../../output modules_install
          
          # 3. Creamos el archivo .tar.gz final con todo
          cd ../../output
          tar -cvzf ../kernel-silvermont-final.tar.gz .

      - name: 6. Subir Artifact (.tar.gz)
        uses: actions/upload-artifact@v4
        with:
          name: linux-tkg-silvermont-raw-tarball
          path: kernel-silvermont-final.tar.gz
