name: xanmod-5.15-release-final

on:
  push:
    branches: [ 5-15-xm ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 1. Checkout
        uses: actions/checkout@v4

      - name: 2. Preparar Entorno y Ccache
        run: |
          sudo apt-get update
          sudo apt-get install -y git build-essential bc bison flex libelf-dev libssl-dev make ccache dwarves libncurses-dev xz-utils kmod lz4
          mkdir -p ~/.ccache
          echo "max_size = 2.0G" > ~/.ccache/ccache.conf

      - name: 3. Configurar GitHub Cache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-xanmod-515-${{ github.sha }}
          restore-keys: ccache-xanmod-515-

      - name: 4. Clonar XanMod 5.15
        run: git clone --depth 1 --branch 5.15 https://github.com/xanmod/linux xanmod

      - name: 5. Configuración Maestra Unificada (Video, WiFi, Silvermont)
        run: |
          cd xanmod
          # 1. Generar base y aplicar modprobed.db
          make x86_64_defconfig
          
          # Habilitamos WLAN antes para que localmodconfig no ignore los drivers de red
          ./scripts/config --enable CONFIG_NETDEVICES
          ./scripts/config --enable CONFIG_WLAN
          

          LSMOD=$GITHUB_WORKSPACE/modprobed.db make localmodconfig
          
          # Definir herramienta de configuración
          KCONFIG="./scripts/config"

          # --- FIX NAVEGADOR (Namespaces) ---
          $KCONFIG --enable CONFIG_USER_NS
          $KCONFIG --enable CONFIG_NAMESPACES
          $KCONFIG --enable CONFIG_UTS_NS
          $KCONFIG --enable CONFIG_IPC_NS
          $KCONFIG --enable CONFIG_PID_NS
          $KCONFIG --enable CONFIG_NET_NS
          # --- [WIFI Y RED] Soporte para RTL8723BE (Legacy y Moderno) ---
          $KCONFIG --enable CONFIG_PCI
          $KCONFIG --enable CONFIG_CFG80211
          $KCONFIG --enable CONFIG_MAC80211
          $KCONFIG --enable CONFIG_WLAN_VENDOR_REALTEK
          # Driver Moderno (Recomendado)
          $KCONFIG --enable CONFIG_RTW88
          $KCONFIG --enable CONFIG_RTW88_PCI
          $KCONFIG --module CONFIG_RTW88_8723be
          # Driver Legacy (El que aparece en tu lista)
          $KCONFIG --enable CONFIG_RTL_CARDS
          $KCONFIG --module CONFIG_RTL8723BE
          $KCONFIG --module CONFIG_RTL8723_COMMON
          $KCONFIG --enable CONFIG_RTLWIFI_PCI
          # Ethernet y Bus
          $KCONFIG --enable CONFIG_R8169
          $KCONFIG --enable CONFIG_RTSX_USB
          $KCONFIG --enable CONFIG_RTSX_USB_SDMMC

          # --- [VIDEO Y CONSOLA] Fix pantalla gris ---
          $KCONFIG --enable CONFIG_FB
          $KCONFIG --enable CONFIG_VT
          $KCONFIG --enable CONFIG_VT_CONSOLE
          $KCONFIG --enable CONFIG_FRAMEBUFFER_CONSOLE
          $KCONFIG --enable CONFIG_DRM_I915
          $KCONFIG --enable CONFIG_DRM_FBDEV_EMULATION
          $KCONFIG --enable CONFIG_FB_EFI
          $KCONFIG --enable CONFIG_FONT_8x16
          $KCONFIG --enable CONFIG_FONT_SUPPORT

          # --- [SILVERMONT] Optimización CPU N2807 ---
          $KCONFIG --disable CONFIG_GENERIC_CPU
          $KCONFIG --enable CONFIG_MSILVERMONT
          $KCONFIG --enable CONFIG_X86_INTEL_PSTATE
          $KCONFIG --enable CONFIG_INTEL_IDLE
          $KCONFIG --enable CONFIG_CPU_FREQ_DEFAULT_GOV_PERFORMANCE
          $KCONFIG --enable CONFIG_MICROCODE
          $KCONFIG --enable CONFIG_MICROCODE_INTEL

          # --- [RENDIMIENTO Y BOOT] ZRAM y Latencia ---
          $KCONFIG --enable CONFIG_ZRAM
          $KCONFIG --enable CONFIG_ZSMALLOC
          $KCONFIG --enable CONFIG_CRYPTO_LZ4
          $KCONFIG --enable CONFIG_ZRAM_DEF_COMP_LZ4
          $KCONFIG --enable CONFIG_SCHED_AUTOGROUP
          $KCONFIG --set-val CONFIG_HZ 1000
          $KCONFIG --enable CONFIG_HZ_1000
          $KCONFIG --enable CONFIG_RD_ZSTD
          $KCONFIG --enable CONFIG_ZSTD_COMPRESS
          $KCONFIG --enable CONFIG_ZSTD_DECOMPRESS


          # 2. Aplicar y limpiar
          make olddefconfig
          echo "Verificando configuración crítica..."
          
          if grep -q "CONFIG_USER_NS=y" .config && grep -q "CONFIG_RTL8723BE=m" .config; then
            echo "✅ CONFIGURACIÓN CORRECTA: WiFi y Namespaces presentes."
            echo "Procediendo a la compilación..."
          else
            echo "❌ ERROR CRÍTICO: Faltan componentes esenciales."
            grep "CONFIG_USER_NS" .config || echo "Falta: CONFIG_USER_NS (El navegador no funcionará)"
            grep "CONFIG_RTL8723BE" .config || echo "Falta: CONFIG_RTL8723BE (El WiFi no funcionará)"
            exit 1
          fi     

      - name: 6. Compilar
        run: |
          cd xanmod
          export CCACHE_DIR=~/.ccache
          export PATH="/usr/lib/ccache:$PATH"
          make -j$(nproc) bzImage modules

      - name: 7. Empaquetado (Incluye .config)
        run: |
          mkdir -p output/boot
          # Copiamos el kernel
          cp xanmod/arch/x86/boot/bzImage output/boot/vmlinuz-515-xanmod-silvermont
          # Copiamos el archivo .config para tenerlo de respaldo
          cp xanmod/.config output/boot/config-515-xanmod-silvermont
          
          cd xanmod
          sudo make INSTALL_MOD_PATH=../output modules_install
          cd ../output
          sudo rm -f lib/modules/*/build lib/modules/*/source
          tar -cvzf ../kernel-515-slim.tar.gz .

      - name: 8. Crear Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v5.15-slim-${{ github.run_number }}
          name: XanMod 5.15 Slim (Silvermont N2807)
          body: |
            Kernel XanMod 5.15 con drivers de video Intel i915 integrados.
            - Compresión: LZ4
            - Optimizado para Celeron N2807
          files: kernel-515-slim.tar.gz
