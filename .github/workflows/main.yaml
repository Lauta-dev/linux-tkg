name: Linux-TKG Silvermont Generic Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  # Variables maestras para el script de TKG
  _processor_opt: "silvermont"
  _cpusched: "pds"
  _compiler: "gcc"
  _distro: "Arch"
  _kernel_on_diet: "false"
  _modprobeddb: "true"
  _modprobeddb_db_path: "/home/user/modprobed.db"
  _debugdisable: "true"
  _no_confirm: "true"
  PKGDEST: "/home/user/reales_paquetes"

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    container: 
      image: archlinux:latest
      options: --user root

    steps:
      - name: 1. Preparar Sistema (Keys y Dependencias Totales)
        run: |
          # Refrescar llaves de Arch para evitar errores de paquetes corruptos
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Sy --noconfirm archlinux-keyring
          # Instalaci칩n de TODAS las makedepends de tu PKGBUILD
          pacman -Syu --noconfirm git base-devel sudo bc ccache kmod cpio perl tar xz wget \
          pahole python-sphinx python-sphinx_rtd_theme patchutils \
          xmlto docbook-xsl inetutils flex graphviz imagemagick bison libelf

      - name: 2. Checkout de tu repositorio
        uses: actions/checkout@v4

      - name: 3. Configurar Usuario y Entorno TKG
        run: |
          # Crear usuario y darle permisos de sudo
          useradd -m user
          echo "user ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          
          # Clonar TKG oficial
          git clone --depth 1 https://github.com/Frogging-Family/linux-tkg.git /home/user/linux-tkg
          
          # Copiar TUS configuraciones al coraz칩n del build
          cp customization.cfg /home/user/linux-tkg/
          cp modprobed.db /home/user/modprobed.db
          
          # Crear carpetas de salida y dar permisos a 'user' sobre TODO
          mkdir -p ${{ env.PKGDEST }}
          chown -R user:user /home/user/linux-tkg
          chown -R user:user ${{ env.PKGDEST }}
          chown user:user /home/user/modprobed.db

      - name: 4. Inyectar Dieta de Drivers (Video)
        run: |
          # Modificamos el PKGBUILD para desactivar drivers innecesarios
          # Buscamos _tkg_srcprep y a침adimos la limpieza de drivers de video
          sed -i '/_tkg_srcprep/a \  scripts/config --file "${_kernel_work_folder_abs}/.config" --disable CONFIG_DRM_AMDGPU --disable CONFIG_DRM_NOUVEAU --disable CONFIG_DRM_RADEON' /home/user/linux-tkg/PKGBUILD

      - name: 5. Compilar (Makepkg)
        working-directory: /home/user/linux-tkg
        run: |
          # Ejecutamos con su -m para heredar las variables de entorno (env:)
          # yes '' acepta autom치ticamente las opciones de parches por defecto
          su -m user -c "yes '' | makepkg --noconfirm -s"

      - name: 6. Subir Paquetes (.pkg.tar.zst)
        uses: actions/upload-artifact@v4
        with:
          name: kernel-tkg-silvermont-final
          path: /home/user/reales_paquetes/*.pkg.tar.zst
