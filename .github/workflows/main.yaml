name: xanmod-5.15-silvermont-slim

on:
  push:
    branches: [ 5-15-xm ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 1. Checkout del repositorio
        uses: actions/checkout@v4

      - name: 2. Instalar dependencias
        run: |
          sudo apt-get update
          sudo apt-get install -y git build-essential bc bison flex libelf-dev libssl-dev make ccache dwarves libncurses-dev xz-utils kmod

      - name: 3. Configurar Ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-xanmod-515-${{ github.sha }}
          restore-keys: ccache-xanmod-515-

      - name: 4. Clonar XanMod 5.15 (Instrucción de usuario)
        run: |
          git clone --depth 1 --branch 5.15 https://github.com/xanmod/linux xanmod

      - name: 5. Aplicar Modprobed-db y Optimización
        run: |
          cd xanmod
          # Usamos la config base de XanMod
          make x86_64_defconfig
          
          # Inyectamos tu modprobed.db para dejarlo "slim"
          # El archivo debe estar en la raíz de tu repo
          LSMOD=../modprobed.db make localmodconfig
          
          # Forzamos optimización para tu Celeron Silvermont
          scripts/config --enable CONFIG_MATOM

          # Quitamos basura de debug para reducir peso
          scripts/config --disable CONFIG_DEBUG_INFO
          scripts/config --disable CONFIG_DEBUG_KERNEL
          # Aseguramos Preempt Full para respuesta rápida en juegos
          scripts/config --enable CONFIG_PREEMPT

          # Desactivar compresión por defecto (ZSTD/GZIP)
          scripts/config --disable CONFIG_KERNEL_GZIP
          scripts/config --disable CONFIG_KERNEL_ZSTD
          
          # Activar LZ4
          scripts/config --enable CONFIG_KERNEL_LZ4

          # Sincronizamos la config
          make olddefconfig

      - name: 6. Compilar (Usando Ccache)
        run: |
          cd xanmod
          export PATH="/usr/lib/ccache:$PATH"
          make -j$(nproc) bzImage modules

      - name: 7. Empaquetado para Dracut/Systemd-boot
        run: |
          mkdir -p output/boot
          # Nombre claro para tu entrada de systemd-boot
          cp xanmod/arch/x86/boot/bzImage output/boot/vmlinuz-515-xanmod-silvermont
          
          cd xanmod
          sudo make INSTALL_MOD_PATH=../output modules_install
          
          cd ../output
          # Limpiamos enlaces simbólicos rotos antes de comprimir
          sudo rm -f lib/modules/*/build lib/modules/*/source
          sudo tar -cvzf ../kernel-515-xanmod-slim.tar.gz .
          sudo chown $USER:$USER ../kernel-515-xanmod-slim.tar.gz

      - name: 8. Subir Kernel resultante
        uses: actions/upload-artifact@v4
        with:
          name: kernel-5.15-xanmod-slim
          path: kernel-515-xanmod-slim.tar.gz
