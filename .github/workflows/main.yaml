name: Linux-TKG Silvermont Arch-Native Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  tkg-build:
    runs-on: ubuntu-latest
    # AQUÍ ESTÁ EL SECRETO: Usamos una imagen oficial de Arch
    container:
      image: archlinux:latest

    permissions:
      contents: write

    steps:
      - name: Actualizar Arch e Instalar dependencias
        run: |
          pacman -Syu --noconfirm
          # Instalamos la base de desarrollo de Arch
          pacman -S --noconfirm git base-devel ncurses flake8 libelf openssl \
            bison flex ccache xmlto kmod inetutils bc python

      - name: Checkout
        uses: actions/checkout@v4

      - name: Clonar y Preparar
        run: |
          # Importante: TKG no deja correr makepkg como root (por seguridad)
          # Pero en GitHub Actions somos root, así que usamos un pequeño truco
          git clone --depth 1 https://github.com/Frogging-Family/linux-tkg.git
          cp customization.cfg linux-tkg/

      - name: Compilar (Modo Arch Puro)
        run: |
          cd linux-tkg
          # Permitimos que makepkg corra como root (solo para este build de GitHub)
          export MAKEPKG_CONF="/etc/makepkg.conf"
          # Usamos makepkg directamente como indica el README para Arch
          # --noconfirm para que no pregunte nada
          # --syncdeps para que instale lo que falte
          # Se usa el comando de Arch oficial
          chmod -R 777 .
          sudo -u wheel makepkg --noconfirm -si || makepkg --noconfirm --allow-root
        env:
          _distro: "Arch"
          _no_confirm: "true"

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: tkg-arch-${{ github.run_number }}
          files: linux-tkg/*.pkg.tar.zst
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
