name: xanmod-5.15-release-final

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 1. Checkout
        uses: actions/checkout@v4

      - name: 2. Preparar Entorno y Ccache
        run: |
          sudo apt-get update
          sudo apt-get install -y git build-essential bc bison flex libelf-dev libssl-dev make ccache dwarves libncurses-dev xz-utils kmod lz4
          # Forzamos la creaci√≥n del directorio para que el Cache no de error
          mkdir -p ~/.ccache
          echo "max_size = 2.0G" > ~/.ccache/ccache.conf

      - name: 3. Configurar GitHub Cache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-xanmod-515-${{ github.sha }}
          restore-keys: ccache-xanmod-515-

      - name: 4. Clonar XanMod 5.15
        run: git clone --depth 1 --branch 5.15 https://github.com/xanmod/linux xanmod

      - name: 5. Aplicar Modprobed-db y Optimizaci√≥n
        run: |
          cd xanmod
          make x86_64_defconfig
          # Usamos la ruta absoluta para evitar errores de validaci√≥n
          LSMOD=$GITHUB_WORKSPACE/modprobed.db make localmodconfig
          
          scripts/config --enable CONFIG_MATOM
          scripts/config --enable CONFIG_PREEMPT
          scripts/config --disable CONFIG_DEBUG_INFO
          scripts/config --disable CONFIG_KERNEL_GZIP
          scripts/config --disable CONFIG_KERNEL_ZSTD
          scripts/config --enable CONFIG_KERNEL_LZ4
          scripts/config --enable CONFIG_DRM_I915
          
          make olddefconfig

      - name: 6. Compilar
        run: |
          cd xanmod
          export CCACHE_DIR=~/.ccache
          export PATH="/usr/lib/ccache:$PATH"
          make -j$(nproc) bzImage modules

      - name: 7. Empaquetado
        run: |
          mkdir -p output/boot
          cp xanmod/arch/x86/boot/bzImage output/boot/vmlinuz-515-xanmod-lz4
          cd xanmod
          sudo make INSTALL_MOD_PATH=../output modules_install
          cd ../output
          sudo rm -f lib/modules/*/build lib/modules/*/source
          tar -cvzf ../kernel-515-slim.tar.gz .

      - name: 8. Crear Release y subir README
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v5.15-slim-${{ github.run_number }}
          name: XanMod 5.15 Slim (Silvermont N2807)
          body: |
            ### üíª Build Specs
            ```text
            Arquitectura:                        x86_64
            Nombre del modelo:                   Intel(R) Celeron(R) CPU N2807 @ 1.58GHz
            CPU MHz m√°x.:                        2165,8000
            Cach√© L2:                            1 MiB (1 instancia)
            ```
            ### üõ†Ô∏è Optimizaciones
            - **Compresi√≥n:** LZ4
            - **Micro-Arquitectura:** Silvermont (MATOM)
            - **Preemption:** Full (Real-time feel)
            - **Modprobed-db:** Aplicado con √©xito.
          files: kernel-515-slim.tar.gz
