name: Linux-TKG Silvermont (Ubuntu Runner -> Raw Tarball)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04 # El entorno más estable para compilar
    steps:
      - name: 1. Checkout del repositorio
        uses: actions/checkout@v4

      - name: 2. Instalar Dependencias de Compilación (Ubuntu)
        run: |
          sudo apt-get update
          sudo apt-get install -y git build-essential bc bison flex libelf-dev libssl-dev \
          make ccache dwarves libncurses-dev xz-utils kmod

      - name: 3. Clonar TKG y Preparar Config
        run: |
          git clone --depth 1 https://github.com/Frogging-Family/linux-tkg.git
          cp customization.cfg linux-tkg/
          cp modprobed.db linux-tkg/
          
          # Forzamos las variables para tu Silvermont y PDS
          cd linux-tkg
          sed -i 's/^_processor_opt=.*/_processor_opt="silvermont"/' customization.cfg
          sed -i 's/^_cpusched=.*/_cpusched="pds"/' customization.cfg
          sed -i 's/^_modprobeddb=.*/_modprobeddb="true"/' customization.cfg
          sed -i "s|#_modprobeddb_db_path=.*|_modprobeddb_db_path=\"$GITHUB_WORKSPACE/modprobed.db\"|" customization.cfg
          # IMPORTANTE: Desactivamos el empaquetado nativo para que no intente hacer .deb
          sed -i 's/^_distro=.*/_distro="Generic"/' customization.cfg

      - name: 4. Compilar Kernel
        run: |
          cd linux-tkg
          # Usamos WERROR=0 para que no aborte por advertencias tontas de GCC
          export KCFLAGS="-Wno-error"
          # ./install.sh en modo Generic compila y deja los archivos en una carpeta temporal
          yes "" | ./install.sh install

      - name: 5. Empaquetar Kernel + Módulos en .tar.gz
        run: |
          # Creamos una carpeta de estructura limpia
          mkdir -p output/boot
          
          # 1. Copiamos el kernel comprimido y el mapa de símbolos
          cp linux-tkg/linux-src-git/arch/x86/boot/bzImage output/boot/vmlinuz-tkg-silvermont
          cp linux-tkg/linux-src-git/System.map output/boot/
          cp linux-tkg/linux-src-git/.config output/boot/config-tkg-silvermont
          
          # 2. Instalamos los módulos en nuestra carpeta temporal
          cd linux-tkg/linux-src-git
          sudo make INSTALL_MOD_PATH=../../output modules_install
          
          # 3. Creamos el archivo .tar.gz final con todo
          cd ../../output
          tar -cvzf ../kernel-silvermont-final.tar.gz .

      - name: 6. Subir Artifact (.tar.gz)
        uses: actions/upload-artifact@v4
        with:
          name: linux-tkg-silvermont-raw-tarball
          path: kernel-silvermont-final.tar.gz
