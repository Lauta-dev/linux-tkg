name: Linux-TKG Silvermont Hyper-Light

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  tkg-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Instalar Dependencias (Basado en README)
        run: |
          sudo apt-get update
          sudo apt-get install -y git build-essential libncurses-dev flex bison openssl \
            libssl-dev dkms libelf-dev libudev-dev libpci-dev libiberty-dev autoconf \
            xz-utils zstd bc ccache python3 kmod fakeroot

      - name: Cache Kernel Sources
        uses: actions/cache@v4
        with:
          path: linux-tkg/linux-src-git
          key: linux-tkg-src-6.6
          restore-keys: linux-tkg-src-

      - name: Preparar linux-tkg
        run: |
          git clone --depth 1 https://github.com/Frogging-Family/linux-tkg.git
          cp customization.cfg linux-tkg/

      - name: Compilar Kernel
        run: |
          cd linux-tkg
          # Creamos la carpeta de logs que pidi칩 el script para que no tire error de copia
          mkdir -p logs
          # Usamos 'install' porque el script dice que hace 'config + compile'
          # No usamos 'script', usamos las variables de entorno para que no pregunte nada
          ./install.sh install
        env:
          _install_interactively: "false"
          _no_confirm: "true"
          _distro: "arch"

      - name: Organizar Archivos
        if: always() # Para que intente rescatar algo aunque falle
        run: |
          mkdir -p release_files
          # TKG en Arch con makepkg genera los archivos en la ra칤z o en carpetas de salida
          find . -name "*.pkg.tar.zst" -exec cp {} release_files/ \;
          find . -name "vmlinuz*" -exec cp {} release_files/ \;

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: tkg-6.6-silvermont-${{ github.run_number }}
          name: Kernel Linux-TKG 6.6 LTS (Silvermont Optimized)
          body: |
            ## 游 Kernel Personalizado para Intel Silvermont (N2800/N2807)
            
            Este kernel ha sido compilado espec칤ficamente para maximizar la fluidez en hardware limitado.
            
            ### 游 Detalles T칠cnicos:
            - **Versi칩n:** 6.6 LTS (Long Term Support)
            - **Arquitectura:** Optimizado para `Silvermont` (Celeron/Atom)
            - **Scheduler:** `PDS` (Prioriza la respuesta del escritorio e i3)
            - **Compresi칩n:** `LZ4` (El arranque m치s r치pido posible)
            - **Estado:** "Hyper-Light" (Sin drivers innecesarios, sin debug symbols)
            
            ### 游냖 Compatibilidad:
            - **Distro:** Dise침ado para **Arch Linux** y derivados (EndeavourOS, Manjaro).
            - **Formato:** Paquete `.pkg.tar.zst` (Instalaci칩n nativa con Pacman).
            
            ### 游닍 Instrucciones de Instalaci칩n:
            1. Descarg치 el archivo `.pkg.tar.zst` de este Release.
            2. Abr칤 una terminal en la carpeta de descarga.
            3. Instal치 usando pacman:
               ```bash
               sudo pacman -U linux-tkg-silvermont-6.6.x.pkg.tar.zst
               ```
            4. Actualiz치 tu cargador de arranque (GRUB o systemd-boot).
            5. Reinici치 y seleccion치 el nuevo kernel en el men칰.
            
            ---
            *Compilado autom치ticamente v칤a GitHub Actions.*
          files: release_files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
