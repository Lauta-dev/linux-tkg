name: Compile & Release Linux-TKG 6.6 LTS

on:
  push:
    branches:
      - '6.6-latest-tkg'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    container:
      image: archlinux:latest
      options: --privileged

    steps:
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 0. Generar tag din√°mico (fecha + short SHA)
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Generate release tag
        id: tag
        run: |
          TAG="v6.6-$(date +'%Y%m%d')-$(echo ${{ github.sha }} | cut -c1-7)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Tag generado: $TAG"

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 1. Checkout del repo propio
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Checkout lauta-dev/linux-tkg
        uses: actions/checkout@v4
        with:
          repository: 'lauta-dev/linux-tkg'
          ref: '6.6-latest-tkg'
          path: 'myrepo'

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 2. Cache de paquetes de pacman
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Cache pacman packages
        uses: actions/cache@v4
        with:
          path: /var/cache/pacman/pkg
          key: pacman-v1
          restore-keys: |
            pacman-

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 3. Dependencias del sistema
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Install System Tools
        run: |
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Syu --noconfirm --needed \
            git base-devel sudo \
            xmlto kmod inetutils bc libelf \
            python pahole cpio perl tar xz zstd

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 4. Checkout de Frogging-Family/linux-tkg
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Checkout Frogging-Family/linux-tkg
        uses: actions/checkout@v4
        with:
          repository: 'Frogging-Family/linux-tkg'
          path: 'linux-tkg'

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 5. Cache del tarball del kernel 6.6
      #    TKG descarga linux-6.6.tar.xz (~130 MB) en src/
      #    Si el cache existe, TKG lo detecta y no re-descarga.
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Cache kernel source tarball
        id: cache-kernel
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/linux-tkg/src
          key: kernel-src-6.6-${{ hashFiles('myrepo/customization.cfg') }}
          restore-keys: |
            kernel-src-6.6-

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 6. Setup: modprobed.db + customization.cfg
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Setup modprobed.db and config
        run: |
          mkdir -p /home/runner/
          cp ${{ github.workspace }}/myrepo/modprobed.db /home/runner/modprobed.db
          cp ${{ github.workspace }}/myrepo/customization.cfg \
             ${{ github.workspace }}/linux-tkg/customization.cfg

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 7. Enforce critical configs
      #    Genera config-fragment.cfg SIN indentaci√≥n para que
      #    merge_config.sh de linux-tkg lo parsee correctamente.
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Enforce critical configs
        run: |
          mkdir -p ${{ github.workspace }}/linux-tkg/linux66-tkg-userpatches
          FRAG="${{ github.workspace }}/linux-tkg/linux66-tkg-userpatches/config-fragment.cfg"

          printf '%s\n' \
            '# Video / pantalla gris fix' \
            'CONFIG_FB=y' \
            'CONFIG_VT=y' \
            'CONFIG_VT_CONSOLE=y' \
            'CONFIG_FRAMEBUFFER_CONSOLE=y' \
            'CONFIG_DRM_FBDEV_EMULATION=y' \
            'CONFIG_FB_EFI=y' \
            'CONFIG_FONT_8x16=y' \
            'CONFIG_FONT_SUPPORT=y' \
            '# WiFi RTL8723BE - ambos drivers' \
            'CONFIG_CFG80211=m' \
            'CONFIG_MAC80211=m' \
            'CONFIG_WLAN_VENDOR_REALTEK=y' \
            'CONFIG_RTL8723BE=m' \
            'CONFIG_RTL8723_COMMON=m' \
            'CONFIG_RTLWIFI=m' \
            'CONFIG_RTLWIFI_PCI=m' \
            'CONFIG_RTW88=m' \
            'CONFIG_RTW88_PCI=m' \
            'CONFIG_RTW88_8723BE=m' \
            '# Namespaces' \
            'CONFIG_USER_NS=y' \
            'CONFIG_NAMESPACES=y' \
            'CONFIG_NET_NS=y' \
            'CONFIG_PID_NS=y' \
            '# ZRAM' \
            'CONFIG_ZRAM=m' \
            'CONFIG_ZSMALLOC=y' \
            'CONFIG_ZRAM_DEF_COMP_LZ4=y' \
            > "$FRAG"

          echo "=== config-fragment.cfg generado ==="
          cat "$FRAG"

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 8. Prepare: descargar source y generar .config
      #    Usamos makepkg --nobuild para que TKG ejecute
      #    solo las fases fetch + prepare() sin compilar.
      #    Esto genera el .config que verificamos a continuaci√≥n.
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Prepare kernel source and generate .config
        run: |
          cd ${{ github.workspace }}/linux-tkg

          # makepkg --nobuild ejecuta: fetch de fuentes + prepare()
          # prepare() es donde TKG aplica patches, modprobed.db
          # y config-fragment.cfg ‚Äî sin llegar a make
          yes "" | makepkg --nobuild --noconfirm --skippgpcheck 2>&1 || true

          # Verificar que el .config fue generado
          CONFIG=$(find src -name ".config" 2>/dev/null | head -1)
          if [ -z "$CONFIG" ]; then
            echo "‚ùå ERROR: makepkg --nobuild no gener√≥ el .config"
            echo "Contenido de src/:"
            ls -la src/ 2>/dev/null || echo "src/ no existe"
            exit 1
          fi
          echo "‚úÖ .config generado en: $CONFIG"
        env:
          MAKEFLAGS: "-j$(nproc)"

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 9. Verificar m√≥dulos del modprobed.db en el .config
      #    ANTES de compilar ‚Äî falla r√°pido si falta algo.
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Verify modprobed.db modules in .config
        run: |
          CONFIG=$(find ${{ github.workspace }}/linux-tkg/src -name ".config" 2>/dev/null | head -1)

          if [ -z "$CONFIG" ]; then
            echo "‚ùå ERROR: No se encontr√≥ .config"
            exit 1
          fi

          echo "‚úÖ .config: $CONFIG"
          echo ""

          MODPROBED="/home/runner/modprobed.db"
          MISSING=()

          while IFS= read -r mod; do
            [[ -z "$mod" ]] && continue
            config_name="CONFIG_$(echo "$mod" | tr '[:lower:]-' '[:upper:]_')"
            if ! grep -qE "^${config_name}=[ym]" "$CONFIG"; then
              MISSING+=("$mod  ‚Üí  $config_name")
            fi
          done < "$MODPROBED"

          if [ ${#MISSING[@]} -gt 0 ]; then
            echo "‚ö†Ô∏è  M√ìDULOS FALTANTES EN .config (${#MISSING[@]} total):"
            echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
            for m in "${MISSING[@]}"; do
              echo "   ‚úó $m"
            done
            echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
            echo "‚ùå Abortando ‚Äî correg√≠ el modprobed.db o customization.cfg antes de recompilar"
            exit 1
          fi

          echo "‚úÖ Todos los m√≥dulos del modprobed.db est√°n presentes en .config"
          echo "üöÄ Procediendo a compilar..."

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 10. Cache de objetos de compilaci√≥n (ccache)
      #     Reduce dr√°sticamente el tiempo en recompilaciones.
      #     En la primera run no hay cache ‚Äî tarda lo mismo.
      #     En runs siguientes puede bajar de 60 min a 10-15 min.
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Cache ccache objects
        uses: actions/cache@v4
        with:
          path: /root/.ccache
          key: ccache-kernel-6.6-${{ hashFiles('myrepo/customization.cfg') }}-${{ github.sha }}
          restore-keys: |
            ccache-kernel-6.6-${{ hashFiles('myrepo/customization.cfg') }}-
            ccache-kernel-6.6-

      - name: Install and configure ccache
        run: |
          pacman -S --noconfirm --needed ccache
          ccache --max-size=5G
          ccache --zero-stats
          # Agregar ccache al PATH para que make lo use autom√°ticamente
          echo "PATH=/usr/lib/ccache/bin:$PATH" >> $GITHUB_ENV
          echo "CCACHE_DIR=/root/.ccache" >> $GITHUB_ENV

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 11. Compilaci√≥n
      #     makepkg --noextract reutiliza el source ya preparado
      #     en el paso anterior, sin re-descargar ni re-patchear.
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Compile Kernel
        run: |
          cd ${{ github.workspace }}/linux-tkg
          ls -la
          chmod +x non-interactive-build.sh

          # --noextract: reutiliza src/ del paso prepare anterior
          yes "" | makepkg --noextract --noconfirm --skippgpcheck
        env:
          MAKEFLAGS: "-j$(nproc)"
          CCACHE_DIR: /root/.ccache

      - name: Show ccache stats
        if: always()
        run: ccache --show-stats

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 12. Buscar paquetes generados (siempre, para debug)
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Find packages
        if: always()
        run: |
          echo "=== Buscando .pkg.tar.zst ==="
          find ${{ github.workspace }}/linux-tkg -name "*.pkg.tar.zst" 2>/dev/null
          echo "=== Contenido de non-interactive-build-output ==="
          ls -la ${{ github.workspace }}/linux-tkg/non-interactive-build-output/ 2>/dev/null \
            || echo "Directorio no encontrado"

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # 13. Crear Release
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "Linux-TKG 6.6 LTS ‚Äî ${{ steps.tag.outputs.tag }}"
          body: |
            ## üêß Linux-TKG 6.6 LTS ‚Äî Compilado para Intel Celeron N2807 (Bay Trail)

            ### üñ•Ô∏è Hardware Target
            | Campo | Valor |
            |---|---|
            | CPU | Intel Celeron N2807 @ 2.17 GHz (Silvermont) |
            | GPU | Intel Atom Z36xxx/Z37xxx (i915) |
            | RAM | 3.72 GiB |
            | WiFi | Realtek RTL8723BE |
            | OS | EndeavourOS / Arch-based |

            ### ‚öôÔ∏è Configuraci√≥n del Kernel
            | Flag | Valor |
            |---|---|
            | Versi√≥n | 6.6-latest (LTS) |
            | Arquitectura | `silvermont` |
            | Scheduler | `bore` |
            | Timer | 1000 Hz |
            | CPU Governor | `performance` |
            | Mitigaciones | deshabilitadas |
            | modprobed.db | ‚úÖ activado |
            | Debug symbols | ‚ùå deshabilitado |
            | Strip | ‚úÖ activado |

            ### üì¶ M√≥dulos clave incluidos
            - **Video:** `i915`, `drm`, `ttm`, framebuffer console, EFI framebuffer
            - **WiFi:** `rtl8723be`, `rtlwifi`, `rtw88_8723be` (legacy + moderno)
            - **Audio:** `snd_hda_intel` + codec Realtek
            - **Storage:** `ahci`, `sd_mod`, `ext4`, `f2fs`, `ntfs3`
            - **USB 3.0:** `xhci_hcd`, `xhci_pci`
            - **Bluetooth:** `btusb`, `btintel`
            - **ZRAM:** `zram` + `lz4`
            - **T√©rmica:** `processor_thermal_*`, `intel_soc_dts_*`

            ### üì• Instalaci√≥n
            ```bash
            # Descargar los .pkg.tar.zst del release y ejecutar:
            sudo pacman -U linux-tkg-*.pkg.tar.zst linux-tkg-headers-*.pkg.tar.zst

            # Actualizar bootloader (GRUB):
            sudo grub-mkconfig -o /boot/grub/grub.cfg
            ```

            > ‚ö†Ô∏è **Nota:** Este kernel est√° optimizado espec√≠ficamente para el N2807.
            > Las mitigaciones de CPU est√°n deshabilitadas para maximizar rendimiento.
            > No instalar en hardware diferente sin recompilar.
          files: ${{ github.workspace }}/linux-tkg/non-interactive-build-output/*.pkg.tar.zst
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
