name: Linux-TKG Silvermont Generic Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  tkg-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Instalar Dependencias
        run: |
          sudo apt-get update
          sudo apt-get install -y git build-essential libncurses-dev flex bison openssl \
            libssl-dev dkms libelf-dev libudev-dev libpci-dev libiberty-dev autoconf \
            xz-utils zstd bc ccache python3 kmod

      - name: Clonar y Preparar
        run: |
          git clone --depth 1 https://github.com/Frogging-Family/linux-tkg.git
          cp customization.cfg linux-tkg/

      - name: Compilar
        run: |
          cd linux-tkg
          mkdir -p logs
          # El comando 'yes ""' responde 'Enter' a todas las preguntas
          # Las variables de entorno fuerzan las opciones principales
          yes "" | _compiler="gcc" _cpusched="pds" _distro="Generic" _no_confirm="true" _install_interactively="false" ./install.sh config
          
          # Una vez configurado, entramos a compilar a mano para evitar más prompts
          cd linux-src-git
          make -j$(nproc) bzImage
          make -j$(nproc) modules
        env:
          _compiler: "gcc"
          _cpusched: "pds"
          _distro: "Generic"
          _no_confirm: "true"

      - name: Organizar Archivos
        run: |
          mkdir -p release_files
          # El kernel compilado
          cp linux-tkg/linux-src-git/arch/x86/boot/bzImage release_files/vmlinuz-tkg-silvermont
          # El archivo de configuración por si querés verlo
          cp linux-tkg/linux-src-git/.config release_files/kernel-config-utilizado
          
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: tkg-gen-${{ github.run_number }}
          files: release_files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
