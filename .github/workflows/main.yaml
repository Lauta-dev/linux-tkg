name: linux-6.6-tkg-silvermont

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 1. Checkout
        uses: actions/checkout@v4

      - name: 2. Cache de Kernel y Ccache
        uses: actions/cache@v4
        with:
          path: |
            # Cacheamos el clon de git para evitar el fetch completo
            linux-tkg/linux-kernel.git
            # Cacheamos la carpeta de trabajo
            linux-tkg/linux-src-git
            # Cacheamos los binarios de ccache
            .ccache
          # La clave incluye la versión para no mezclar kernels diferentes
          key: linux-6.6-silvermont-${{ runner.os }}-${{ github.sha }}
          # restore-keys permite recuperar el cache de la ejecución anterior
          restore-keys: |
            linux-6.6-silvermont-${{ runner.os }}-

      - name: 3. Preparar Base de Datos (Fake LSMOD)
        run: |
          awk '{print $1 " 0 0"}' modprobed.db > /home/runner/modprobed.db

      - name: 4. Instalar Dependencias
        run: |
          sudo apt-get update
          sudo apt-get install -y git build-essential bc bison flex libelf-dev libssl-dev make ccache dwarves libncurses-dev xz-utils kmod

      - name: 5. Ejecutar Linux-TKG
        run: |
          # Clonamos solo si no existe (por el cache)
          if [ ! -d "linux-tkg" ]; then
            git clone --depth 1 https://github.com/Frogging-Family/linux-tkg.git
          fi
          
          cp customization.cfg linux-tkg/customization.cfg
          
          cd linux-tkg
          # IMPORTANTE: El script detectará automáticamente las carpetas linux-kernel.git
          # y linux-src-git si ya existen gracias al cache.
          yes "" | ./install.sh install

      - name: 5. Empaquetado de Binarios
        run: |
          # Creamos la carpeta de salida
          mkdir -p output/boot
          
          # 1. Copiar el Kernel (el binario ejecutable)
          cp linux-tkg/linux-src-git/arch/x86/boot/bzImage output/boot/vmlinuz-linux66-tkg-silvermont
          
          # 2. Instalar los Módulos en la carpeta output
          cd linux-tkg/linux-src-git
          sudo make INSTALL_MOD_PATH=../../output modules_install
          
          # 3. Limpiar y Comprimir (usando sudo para evitar errores de permisos)
          cd ../../output
          sudo rm -f lib/modules/*/build lib/modules/*/source
          sudo tar -cvzf ../kernel-66-silvermont.tar.gz .
          
          # 4. Cambiar el dueño del archivo final para que el Action pueda subirlo
          sudo chown $USER:$USER ../kernel-66-silvermont.tar.gz

      - name: 7. Subir Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-tkg-6.6-silvermont
          path: kernel-66-silvermont.tar.gz
